<!DOCTYPE html>
<meta charset="utf-8">
<style>

.link {
  stroke: #ccc;
}

.node text {
  pointer-events: none;
  font: 10px sans-serif;
}

</style>
<body>
    {% load static %}
    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <!--
    <script src={% static "gravapp/jquery.js" %}></script>
    <script src={% static "gravapp/d3.js" %}></script>
    -->
    <script>
        var width = 960,
        height = 500

        var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

        var force = d3.layout.force()
        .gravity(0.05)
        .distance(100)
        .charge(-100)
        .size([width, height]);

        var node = svg.selectAll(".node")

        var data = {{ context|safe }};
        var nodes = data.nodes;

        var json = JSON.parse((JSON.stringify(data)));

        function updateGraph() {
            force
              .nodes(nodes)
              //.nodes(json.nodes)
              .links(json.links)
              .start();

            var link = svg.selectAll(".link")
              .data(json.links)
            .enter().append("line")
              .attr("class", "link");

            node = node.data(force.nodes(), function(d) { return d.name; });
            
            node.enter().append("g")
              .attr("class", "node")
              .call(force.drag);

            node.exit().remove();

            node.append("circle")
              .attr("r", 5);
              //.attr("fill", function(d) { return color(d.group); })

            node.append("text")
              .attr("dx", 12)
              .attr("dy", ".35em")
              .text(function(d) { return d.name });

            force.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

                node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
            });
        } updateGraph();
    </script>
    <script>
        $(function() { 
            var $first_name_field = $('#id_first_name');
            var $last_name_field = $('#id_last_name');

            $('#create-btn').click(function() {
                var fst_name = $first_name_field.val();
                var lst_name = $last_name_field.val();
                var name = { 'first_name': fst_name, 'last_name': lst_name };

                $.post('/create_character/', name, function(res) {
                    console.log(res);
                    nodes.push({ 'name': fst_name });

                    updateGraph();

                    clearFields();
                }); 

                return false;
            });

            $('#del-btn').click(function() {
                var name = $first_name_field.val();

                $.post('/delete_character/', {'name': name}, function(res) {
                    console.log(res);
                    for (var i = 0; i < nodes.length; i++) {
                        if (nodes[i].name.toLowerCase() === name.toLowerCase()) {
                            nodes.splice(i, 1);
                        }
                    }

                    updateGraph();

                    clearFields();
                });

                return false;
            });

            function clearFields() {
                $first_name_field.val('');
                $last_name_field.val('');
            }
        });
    </script>
    <form method="post">
        {% csrf_token %}
        {{ form }}

        <input id="create-btn" type="submit" value="Create" />
        <input id="del-btn" type="submit" value="Delete (looks at first name only)" />
    </form>